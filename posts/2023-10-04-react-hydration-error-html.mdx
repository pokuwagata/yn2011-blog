---
title: React の Hydration エラーと HTML のコンテンツモデル違反
date: 2023-10-04
public: true
---

# React の Hydration エラーと HTML のコンテンツモデル違反

## Hydration エラー

Next.js を使って開発していると、以下のような Hydration エラーが発生することがある。

`Text content does not match server-rendered HTML`

サーバーサイドでレンダリングされた HTML とブラウザでレンダリングされた HTML に差異が発生している場合に起きる。

差異が発生する理由はいくつかあるが、HTML のコンテンツモデル違反によりブラウザが HTML を補完している場合がある。
ブラウザが HTML を補完するというのはどういうことなのか？

## ブラウザが HTML を補完する

いくつかパターンがあるので列挙する。

### div タグと p タグ

サーバーで以下の HTML を生成する。

```html
<p>
  <div>test</div>
</p>
```

これをブラウザが補完するとこうなる。

```html
<p></p> <!-- 終了タグが追加されている -->
<div>test</div>
<p></p>
```

p タグの子要素にはフレージング・コンテンツのみが許可されているが、div タグはフレージング・コンテンツではない。
したがってこれはコンテンツモデルに違反していることになるので、ブラウザが違反していない形に補完している。

### 終了タグの補完

サーバーで以下の HTML を生成する。

```html
<p>
  <b>
    <b>
      <b>
        <b>4
```

これをブラウザが補完すると以下になる。

```html
<p>
  <b>
    <b>
      <b>
        <b>4</b>
      </b> <!-- 終了タグが追加されている -->
    </b>
  </b>
</p>
```

ちなみに、終了タグの補完についてはノアの方舟(Noah's Ark) と呼ばれる補完仕様が存在する。[^1]
開始タグの子が複数の場合、2 番目以降の子に対しては終了タグに対応するタグが 3 つまでしか補完されない。

```html
<p>
  <b>
    <b>
      <b>
        <b>4
          <p>3</p>
```

ブラウザが補完すると以下になる。直前に b タグが 4 つあるが 3 つまでしか補完されない（残りは無視される）

```html
// 省略
<p>
  <b>
    <b>
      <b>3</b>
    </b>
  </b> <!-- 終了タグの補完は 3 つだけ -->
</p>
```

### foster parenting

[foster parenting](https://html.spec.whatwg.org/multipage/parsing.html#creating-and-inserting-nodes) と呼ばれる仕様がある。

サーバーで以下の HTML を生成する。

```html
<table>
  <p>test</p>
</table>
```

これをブラウザが補完すると以下になる。

```html
<p>test</p> <!-- 追い出されている -->
<table></table>
```

table タグの子要素に p タグを配置するのはコンテンツモデル違反のため、p タグが外側に移動する。
ちなみに foster parent は里親・育ての親という意味らしく、子要素を別の親要素に託す仕様の比喩と思われる。

## まとめ

ブラウザは HTTP レスポンスの HTML をそのままパースするのではなく、いくつかの仕様に沿って HTML を改変することがある。
サーバーサイドレンダリング時に、コンテンツモデル違反に該当する HTML を生成すると Hydration エラーに繋がる場合があるので
注意しよう。

[^1]: 太田 良典, 中村 直樹 (2022). HTML 解体新書 ボーンデジタル